---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase/supabaseClient";
import { marked } from 'marked'; 
import "../../styles/global.css";

// Get the post by slug
const { slug } = Astro.params;

const { data: post, error } = await supabase
    .from('posts')
    .select('title, content, published_at, images, parent_id')
    .eq('slug', slug)
    .single();
if (error) {
    throw new Error(`Post not found: ${error.message}`);
}

// Convert Markdown content to HTML
const htmlContent = post ? marked(post.content) : '';

// Get related posts based on parent_id
// NOTE: Currently showing 2 posts. Change .limit(2) to .limit(3) to show 3 posts
const { data: relatedPosts, error: relatedError } = await supabase
    .from('posts')
    .select('title, slug, content, images, published_at')
    .eq('parent_id', post ? post.parent_id : null)
    .neq('slug', slug) // Exclude current post
    .limit(2); // ðŸ‘ˆ Change this to .limit(3) when you want to show 3 posts

if (relatedError) {
    console.error(`Error fetching related posts: ${relatedError.message}`);
}

console.log('Related Posts:', relatedPosts);
---

<Layout>
    <div class="bg-gray-50 min-h-screen flex flex-col">
    {post && (
      <div class="w-full max-w-full sm:max-w-2xl lg:max-w-3xl mx-auto px-4 py-6 sm:px-6 lg:px-8 lg:py-8">
        {/* Main Article */}
        <article class="bg-white rounded-lg shadow-lg border border-gray-200 mb-8">
          <div class="px-4 py-6 sm:px-6 lg:px-8 lg:py-8">
            <header class="mb-4 sm:mb-6 border-b border-gray-100 pb-3 sm:pb-4">
              <h1 class="text-2xl font-extrabold text-gray-900 mb-1 leading-tight sm:text-3xl lg:text-4xl">
                {post.title}
              </h1>
              <p class="text-xs text-gray-500 italic sm:text-sm">
                Published on {new Date(post.published_at).toLocaleDateString()}
              </p>
            </header>
            {post.images && post.images[0] && (
              <div class="flex flex-col items-center gap-2 mb-4 w-full">
                <img
                  src={post.images[0]}
                  alt={post.title + ' poster'}
                  class="w-4/5 max-w-lg object-contain rounded-md mx-auto rounded-poster"
                  style="max-height:400px;"
                  loading="lazy"
                />
                <span class="text-xs italic text-gray-500 mt-1">Image source: themoviedb.org</span>
              </div>
            )}
            <section class="prose prose-base text-gray-800 sm:prose-lg lg:prose-xl">
              <article set:html={htmlContent} />
            </section>
            {post.images && post.images[1] && (
              <div class="flex flex-col items-center gap-2 mb-4">
                <img
                  src={post.images[1]}
                  alt={post.title + ' backdrop'}
                  class="w-4/5 max-w-lg object-contain rounded-md mx-auto"
                  style="max-height:400px;"
                  loading="lazy"
                />
                <span class="text-xs italic text-gray-500 mt-1">Image source: themoviedb.org</span>
              </div>
            )}
          </div>
        </article>

        {/* Related Posts Section */}
        {relatedPosts && relatedPosts.length > 0 && (
          <section class="bg-white rounded-lg shadow-lg border border-gray-200 p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
              <svg class="w-5 h-5 mr-2 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path>
              </svg>
              Related Posts
            </h2>
            
            {/* Grid responsive: 1 col on mobile, 2 cols on md+ (perfect for 2 items) */}
            {/* NOTE: Change to "lg:grid-cols-3" if you switch back to showing 3 posts */}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              {relatedPosts.map((relatedPost) => (
                <div class="group bg-gradient-to-br from-white to-gray-50 rounded-xl shadow-md hover:shadow-xl border border-gray-100 overflow-hidden transition-all duration-300 hover:scale-[1.02] hover:border-blue-200">
                  <a href={`/posts/${relatedPost.slug}`} class="block">
                    {relatedPost.images && relatedPost.images[0] && (
                      <div class="relative overflow-hidden h-40 bg-gray-200">
                        <img
                          src={relatedPost.images[0]}
                          alt={relatedPost.title + ' poster'}
                          class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                          loading="lazy"
                        />
                        <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                      </div>
                    )}
                    
                    <div class="p-4">
                      <h3 class="font-bold text-gray-900 text-sm mb-2 line-clamp-2 group-hover:text-blue-600 transition-colors duration-200">
                        {relatedPost.title}
                      </h3>
                      
                      {relatedPost.content && (
                        <p class="text-gray-600 text-xs mb-3 line-clamp-3">
                          {relatedPost.content.length > 100 ? relatedPost.content.slice(0, 100) + '...' : relatedPost.content}
                        </p>
                      )}
                      
                      <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500">
                          {new Date(relatedPost.published_at).toLocaleDateString()}
                        </span>
                        <span class="text-xs text-blue-500 font-medium group-hover:text-blue-700 transition-colors duration-200">
                          Read More â†’
                        </span>
                      </div>
                    </div>
                  </a>
                </div>
              ))}
            </div>
          </section>
        )}
      </div>
    )}
    {!post && (
      <div class="w-full max-w-full sm:max-w-2xl mx-auto p-8 text-center bg-red-50 border border-red-200 rounded-lg mt-10">
        <p class="text-red-700 text-lg font-semibold">POST not found :/...</p>
      </div>
    )}
    </div>
</Layout>

<style>
    .rounded-poster {
        border-radius: 12rem;
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>